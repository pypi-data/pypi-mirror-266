import{bE as z,aE as f,u as T,F as G,aP as ee,ao as te,b3 as V,cW as ie,cX as H,cY as se,bL as le,bU as Z,c0 as re,bV as oe,cZ as ne,aM as g,c_ as ae,c$ as de,d0 as ue,d1 as N,c1 as ce,d2 as fe,d3 as me,d4 as pe,d5 as he,s as b,bx as n,bH as P,d6 as ge,d7 as be,aR as R,I as r,bJ as _,bI as v,b$ as we,bT as D,H as x,bZ as W,bQ as ye,am as B,bR as ve,bS as Le,d8 as ke,v as q,t as U,d9 as _e}from"./index-C2AHI-HK.js";import{V as xe,b as Ie}from"./ViewToolbar-CVjJgDJD.js";import{g as Te}from"./graphql-BScASb0Q.js";import{u as Ve,i as Fe,a as I}from"./initialOptions-DCNtfDfN.js";import{V as Se}from"./VAlert-DabNp_ty.js";const De={name:"LogComponent",props:{placeholder:{type:String,required:!1},timestamps:{type:Boolean,required:!1,default:!0},logs:{type:Array,required:!0},wordWrap:{type:Boolean,required:!1,default:!1}},data(){return{match:""}},computed:{computedLogs(){return this.logs.length>0?this.timestamps?this.logs:this.updateLogs():this.placeholder?[this.placeholder]:[]}},methods:{updateLogs(){return this.logs.map(e=>this.stripTimestamp(e))},stripTimestamp(e){const t=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-][\d:]+)?\s(.*\s*)/;return this.match=e.match(t),this.match?this.match[1]:e}}};function Ce(e,t,s,i,d,u){return f(),T("pre",null,[(f(!0),T(G,null,ee(u.computedLogs,(c,o)=>(f(),T("span",{key:o,class:te(s.wordWrap?"text-pre-wrap":"text-pre")},V(c),3))),128))])}const Oe=z(De,[["render",Ce]]);var Ee=ie,je=function(){return Ee.Date.now()},Ne=je,Pe=/\s/;function Re(e){for(var t=e.length;t--&&Pe.test(e.charAt(t)););return t}var We=Re,Be=We,qe=/^\s+/;function Ue(e){return e&&e.slice(0,Be(e)+1).replace(qe,"")}var Ae=Ue,$e=Ae,A=H,Me=se,$=NaN,Qe=/^[-+]0x[0-9a-f]+$/i,ze=/^0b[01]+$/i,Ge=/^0o[0-7]+$/i,He=parseInt;function Ze(e){if(typeof e=="number")return e;if(Me(e))return $;if(A(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=A(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=$e(e);var s=ze.test(e);return s||Ge.test(e)?He(e.slice(2),s?2:8):Qe.test(e)?$:+e}var Je=Ze,Xe=H,C=Ne,M=Je,Ye="Expected a function",Ke=Math.max,et=Math.min;function tt(e,t,s){var i,d,u,c,o,a,h=0,L=!1,m=!1,w=!0;if(typeof e!="function")throw new TypeError(Ye);t=M(t)||0,Xe(s)&&(L=!!s.leading,m="maxWait"in s,u=m?Ke(M(s.maxWait)||0,t):u,w="trailing"in s?!!s.trailing:w);function F(l){var p=i,y=d;return i=d=void 0,h=l,c=e.apply(y,p),c}function J(l){return h=l,o=setTimeout(k,t),L?F(l):c}function X(l){var p=l-a,y=l-h,j=t-p;return m?et(j,u-y):j}function O(l){var p=l-a,y=l-h;return a===void 0||p>=t||p<0||m&&y>=u}function k(){var l=C();if(O(l))return E(l);o=setTimeout(k,X(l))}function E(l){return o=void 0,w&&i?F(l):(i=d=void 0,c)}function Y(){o!==void 0&&clearTimeout(o),h=0,i=a=d=o=void 0}function K(){return o===void 0?c:E(C())}function S(){var l=C(),p=O(l);if(i=arguments,d=this,a=l,p){if(o===void 0)return J(a);if(m)return clearTimeout(o),o=setTimeout(k,t),F(a)}return o===void 0&&(o=setTimeout(k,t)),c}return S.cancel=Y,S.flush=K,S}var it=tt;const st=le(it),lt=Z`
subscription LogData ($id: ID!, $file: String!) {
  logs (id: $id, file: $file) {
    lines
    connected
    path
    error
  }
}
`,rt=Z`
query LogFiles($id: ID!) {
  logFiles(id: $id) {
    files
  }
}
`,ot=[/^job\.out$/,/^job$/,/^scheduler\/*/],nt=e=>{if(e.length){for(const t of ot)for(const s of e)if(t.exec(s))return s}return null};class Q{constructor(){this.lines=[],this.path=null,this.connected=null,this.error=null}}class at extends ge{constructor(t){super(),this.results=t}onAdded(t,s,i){this.results.connected===!1&&(this.results.lines=[]),t.lines&&this.results.lines.push(...t.lines),t.connected!=null&&(this.results.connected=t.connected),t.error!=null&&(this.results.error=t.error),t.path!=null&&(this.results.path=t.path)}}const dt={name:"Log",mixins:[Te,re],components:{LogComponent:Oe,ViewToolbar:xe},head(){return{title:oe("App.workflow",{name:this.workflowName})}},emits:[Ve],props:{initialOptions:Fe},setup(e,{emit:t}){const s=be(),i=I("relativeID",{props:e,emit:t}),d=ne(i),u=I("file",{props:e,emit:t}),c=I("timestamps",{props:e,emit:t},!0),o=I("wordWrap",{props:e,emit:t},!1),a=g(new Q);function h(){a.value=new Q}ae(()=>s.state.offline,()=>{a.value.connected=!1});const L=st(w=>{i.value=w},500),m="40";return{query:g(null),logFiles:g([]),results:a,relativeID:i,previousRelativeID:d,file:u,fileLabel:g("Select File"),fileDisabled:g(!1),jobLog:g(i.value==null?0:1),timestamps:c,wordWrap:o,reset:h,debouncedUpdateRelativeID:L,toolbarBtnSize:m,toolbarBtnProps:Ie(m)}},data(){return{controlGroups:[{title:"Log",controls:[{title:"Timestamps",icon:de,action:"toggle",value:this.timestamps,key:"timestamps"},{title:"Word wrap",icon:ue,action:"toggle",value:this.wordWrap,key:"wordWrap"}]}]}},mounted(){this.$watch(()=>({id:this.id??void 0,file:this.file??void 0}),async({id:e},t)=>{this.updateQuery(),e!==(t==null?void 0:t.id)&&await this.updateLogFileList()},{immediate:!0})},computed:{workflowTokens(){return new N(this.workflowId)},id(){if(this.jobLog)try{const e=new N(this.relativeID,!0);return e!=null&&e.task?this.workflowTokens.clone({cycle:e.cycle,task:e.task,job:e.job}).id:null}catch{return null}return this.workflowId}},methods:{setOption(e,t){this[e]=t},updateQuery(){if(this.reset(),!this.file||!this.id){this.query=null;return}this.query=new ce(lt,{id:this.id,file:this.file},`log-query-${this._uid}`,[new at(this.results)],!1,!1)},async updateLogFileList(e=!0){var i;if(!this.id){this.handleNoLogFiles();return}this.fileLabel="Updating available files...",this.fileDisabled=!0;let t;try{t=await this.$workflowService.apolloClient.query({query:rt,variables:{id:this.id}})}catch(d){console.warn(d),this.handleNoLogFiles();return}if(!this.id)return;const s=((i=t.data.logFiles)==null?void 0:i.files)??[];e&&(this.file&&!s.includes(this.file)&&(this.file=null),this.file||(this.file=nt(s))),s.length?(this.fileLabel="Select File",this.fileDisabled=!1,this.logFiles=s):this.handleNoLogFiles()},handleNoLogFiles(){this.fileLabel=this.id?`No log files for ${this.id}`:"Enter a task/job ID",this.fileDisabled=!0,this.logFiles=[]}},watch:{jobLog(e,t){this.file=null,this.relativeID=e?this.previousRelativeID:null}},icons:{mdiFileAlertOutline:fe,mdiFolderRefresh:me,mdiPowerPlug:pe,mdiPowerPlugOff:he}},ut={"data-cy":"log-path",style:{"padding-left":"0.5em",color:"rgb(150,150,150)"}},ct={class:"text-pre-wrap text-break"};function ft(e,t,s,i,d,u){const c=R("ViewToolbar"),o=R("log-component");return f(),b(P,{class:"c-log h-100 pa-0 d-flex flex-column",fluid:""},{default:n(()=>[r(P,{fluid:""},{default:n(()=>[r(_,{dense:"",class:"flex-0-0"},{default:n(()=>[r(v,{class:"pt-0"},{default:n(()=>[r(we,{modelValue:i.jobLog,"onUpdate:modelValue":t[0]||(t[0]=a=>i.jobLog=a),divided:"",mandatory:"",variant:"outlined",color:"primary",density:"comfortable"},{default:n(()=>[r(D,{"data-cy":"workflow-toggle"},{default:n(()=>[x("Workflow")]),_:1}),r(D,{"data-cy":"job-toggle"},{default:n(()=>[x("Job")]),_:1})]),_:1},8,["modelValue"]),r(c,{groups:d.controlGroups,onSetOption:u.setOption,size:i.toolbarBtnSize},null,8,["groups","onSetOption","size"])]),_:1})]),_:1}),r(_,{dense:"",class:"flex-0-0"},{default:n(()=>[r(v,{cols:"8"},{default:n(()=>[i.jobLog?(f(),b(W,{key:0,"data-cy":"job-id-input",class:"flex-grow-1 flex-column","model-value":i.relativeID,"onUpdate:modelValue":i.debouncedUpdateRelativeID,placeholder:"cycle/task/job",clearable:""},null,8,["model-value","onUpdate:modelValue"])):(f(),b(W,{key:1,"data-cy":"workflow-id-input",modelValue:e.workflowId,"onUpdate:modelValue":t[1]||(t[1]=a=>e.workflowId=a),disabled:""},null,8,["modelValue"]))]),_:1}),r(v,{cols:"4",class:"d-flex col-gap-2"},{default:n(()=>[r(ye,{"data-cy":"file-input",label:i.fileLabel,disabled:i.fileDisabled,items:i.logFiles,modelValue:i.file,"onUpdate:modelValue":t[2]||(t[2]=a=>i.file=a),clearable:"","menu-props":{"data-cy":"file-input-menu"}},null,8,["label","disabled","items","modelValue"]),r(D,B({onClick:t[3]||(t[3]=()=>this.updateLogFileList(!1))},i.toolbarBtnProps,{"data-cy":"refresh-files"}),{default:n(()=>[r(ve,{icon:e.$options.icons.mdiFolderRefresh},null,8,["icon"]),r(Le,null,{default:n(()=>[x("Refresh file list")]),_:1})]),_:1},16)]),_:1})]),_:1}),r(_,{dense:"",class:"flex-0-0"},{default:n(()=>[i.results.path?(f(),b(v,{key:0,class:"d-flex align-center overflow-x-auto text-pre"},{default:n(()=>[r(ke,B({"data-cy":"connected-icon",variant:"outlined",class:"flex-shrink-0"},i.results.connected?{color:"success",prependIcon:e.$options.icons.mdiPowerPlug}:{color:"error",prependIcon:e.$options.icons.mdiPowerPlugOff,onClick:u.updateQuery}),{default:n(()=>[x(V(i.results.connected?"Connected":"Reconnect"),1)]),_:1},16),q("span",ut,V(i.results.path),1)]),_:1})):U("",!0)]),_:1})]),_:1}),r(_,{"no-gutters":"",class:"overflow-auto px-4 pb-2"},{default:n(()=>[r(v,null,{default:n(()=>[u.id&&i.file&&i.results.connected==null?(f(),b(_e,{key:0,type:"text@5",class:"mx-n4 align-content-start"})):(f(),T(G,{key:1},[i.results.error?(f(),b(Se,{key:0,type:"error",variant:"tonal",density:"comfortable",class:"mb-4",icon:e.$options.icons.mdiFileAlertOutline},{default:n(()=>[q("span",ct,V(i.results.error),1)]),_:1},8,["icon"])):U("",!0),r(o,{"data-cy":"log-viewer",logs:i.results.lines,timestamps:i.timestamps,"word-wrap":i.wordWrap},null,8,["logs","timestamps","word-wrap"])],64))]),_:1})]),_:1})]),_:1})}const wt=z(dt,[["render",ft]]);export{wt as default,nt as getDefaultFile};
