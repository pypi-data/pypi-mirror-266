
{% extends 'accounting.html' %}

{% load i18n static notify categories widget_tweaks pipeline %}


{% block bodyclass %}{{ block.super }} hidden-breadcrumbs{% endblock %}


{% block title %}
    {{ invoice.model_name }} #{{ invoice.id }}
{% endblock %}


{% block content %}
    {{ block.super }}

    <h4>
        {{ invoice.model_name }} #{{ invoice.id }}
        <small>({{ invoice.get_type_display }})</small>
        <span class="pull-right">
            <i class="fa fa-clock-o"></i> {{ invoice.created|date:'d.m.Y' }}
        </span>
    </h4>

    <div class="row">
        <div class="col-md-8">
            <div class="d-flex" style="gap: 10px;">
                <button class="btn btn-link btn-sm {% if is_product_select_collapsed %}collapsed{% endif %}"
                        type="button"
                        data-toggle="collapse"
                        data-target="#select-product-collapse"
                        aria-expanded="{{ is_product_select_collapsed|yesno:'false,true' }}"
                        aria-controls="select-product-collapse">
                    {% trans 'Products' %} <i class="fa fa-chevron-down"></i>
                </button>
                {% if form.supplier %}
                    {{ form.supplier|add_class:'invoice-contact-select' }}
                {% endif %}
                {% if form.customer %}
                    {{ form.customer|add_class:'invoice-contact-select' }}
                {% endif %}
                {{ form.manager|add_class:'invoice-contact-select' }}
                {% if form.currency %}
                    <div class="input-group input-group-sm invoice-currency-input-group">
                        {{ form.currency|add_class:'form-control' }}
                        {{ form.currency_rate|add_class:'form-control' }}
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4">
            <a href="{{ invoice.print_url }}"
               target="blank"
               class="btn btn-primary btn-sm pull-right">
                <i class="fa fa-print"></i> {% trans 'Print' %}
            </a>
            {% if invoice.invoice_type == 'sale' %}
                <a href="javascript:void(0)"
                   data-role="add-customer"
                   class="btn btn-warning btn-sm pull-right"
                   style="margin-right: 10px"
                   data-url="{% url 'admin:customers_customer_add' %}?_popup=1">
                    <i class="fa fa-user"></i>
                    {% trans 'Add customer' %}
                </a>
            {% endif %}
        </div>
    </div>

    <hr />

    <div data-role="products-section">
        {% include 'invoices/product-select-list.html' %}

        <table class="table table-bordered table-sm m-t-20" data-role="product-invoice-list">
            <thead>
                <tr>
                    <th>
                        {% trans 'Code' %}
                    </th>
                    <th>
                        {% trans 'Product' %}
                        [
                            <a href="javascript:void(0)"
                               data-role="add-product"
                               data-url="{% url 'admin:products_product_add' %}?_popup=1">
                                {% trans 'Add' %}
                            </a>
                        ]
                    </th>
                    <th class="text-center" width="100">
                        {% trans 'Quantity' %}
                    </th>
                    <th class="text-center" width="150">
                        {% trans 'Price' %}
                    </th>
                    <th width="50"></th>
                </tr>
            </thead>
            <tbody data-role="list-items">
                {% for item in invoice.get_items %}
                    {{ item.render }}
                {% endfor %}
            </tbody>
            <tfoot>
                {% if form.discount %}
                    <tr>
                        <td colspan="2" class="text-right">
                            <b>{% trans 'Total without discount' %}:</b>
                        </td>
                        <td colspan="2" data-role="grand_total" class="text-right">
                            {{ invoice.total }}
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="text-right">
                            <b>{% trans 'Discount' %}:</b>
                        </td>
                        <td>
                            <span data-role="discount_percentage">
                                {{ form.discount }}
                            </span>%
                        </td>
                        <td class="text-right" data-role="discounted_total" >
                            {{ invoice.discounted_total }}
                        </td>
                        <td></td>
                    </tr>
                {% endif %}
                <tr>
                    <td colspan="2" class="text-right">
                        <b>{% trans 'Total' %}:</b>
                    </td>
                    <td colspan="2" data-role="total_with_discount" class="text-right">
                        {{ invoice.total_with_discount }}
                    </td>
                    <td></td>
                </tr>
                {% if invoice.invoice_type == 'sale' and are_sale_totals_visible %}
                    <tr>
                        <td colspan="2" class="text-right" data-role="totals-label">
                            {% trans "Cassa" %}
                        </td>
                        <td>
                            {{ form.total_cassa }}
                        </td>
                        <td colspan="2">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="text-right" data-role="totals-label">
                            {% trans "Nova poshta" %}
                        </td>
                        <td>
                            {{ form.total_post }}
                        </td>
                        <td colspan="2">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="text-right" data-role="totals-label">
                            {% trans "Credit card" %}
                        </td>
                        <td>
                            {{ form.total_card }}
                        </td>
                        <td colspan="2">
                        </td>
                    </tr>
                {% endif %}
            </tfoot>
        </table>
    </div>

    {% if invoice.invoice_type == 'sale' %}
        {% include 'services/manage.html' %}
    {% endif %}
{% endblock %}


{% block extrastyle %}
    {{ block.super }}
    {% stylesheet 'invoices' %}
    {{ form.media.css }}
{% endblock %}


{% block js %}

    {{ block.super }}

    {% notify_js %}

    {% javascript 'invoices' %}

    {{ form.media.js }}

    <script>
        (function ($) {

            {% get_categories as product_categories %}

            var $productList = $('[data-role=product-list]');

            new CurrencySelect({
                $container: $('#{{ form.currency.auto_id }}'),
                url: '{{ invoice.update_url }}'
            });

            new CurrencyRateInput({
                $container: $('#{{ form.currency_rate.auto_id }}'),
                url: '{{ invoice.update_url }}'
            });

            new CategoryTree({
                $container: $('[data-role=products-section]'),
                data: [
                    {% for c in product_categories %}
                        {
                            text: "{{ c.name|escapejs }}",
                            id: {{ c.id }}
                        },
                    {% endfor %}
                ]
            });

            new List({
                $container: $productList,
                url: '{% url 'products:list' %}'
            });

            new SelectProductList({
                $container: $productList
            });

            new InvoiceList({
                $container: $('[data-role=product-invoice-list]'),
                addItemUrl: '{{ invoice.add_item_url }}',
                target: 'product',
                areTotalsValid: {{ invoice.are_sale_totals_valid|yesno:"true,false" }},
                totalsValidKey: "are_sale_totals_valid"
            });

            new AdminModal({
                $target: $('[data-role=add-product]'),
                onSuccess: function (response) {
                    $(window).trigger('product-selected', [
                        response.value,
                        {focus: true}
                    ]);
                }
            });

            new AdminModal({
                $target: $('[data-role=add-customer]'),
                onSuccess: function (response) {
                    $(window).trigger('customer-created', [{
                      name: response.obj,
                      id: response.value
                    }]);
                }
            });

            $('body').scannerDetection({
                onComplete: function (code) {
                    var data = {'bar_code': code};
                    $.get('{% url 'products:bar-code-to-id' %}', data, function (response) {
                        $(window).trigger('product-selected', [response]);
                    });
                }
            });
        })(jQuery);
    </script>
{% endblock %}
